<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>IRCTC Booking Date Calculator</title>
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#0b0f1a">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr" onload="initCalendar()" onerror="calendarCDNFailed()"></script>

<style>
:root{ --bg:#0b0f1a; --fg:#e8edf5; --muted:#9fb0c7; --card:#0e1422; --border:#1a2538; --accent:#4da3ff; --ok:#34d399; --warn:#f59e0b; --err:#f87171; }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;display:flex;justify-content:center;padding:18px}
main{width:100%;max-width:980px;display:flex;flex-direction:column;gap:14px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
h1{margin:0 0 6px;font-size:22px}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
input,select,button{font:inherit}
.input{width:100%;border:1px solid var(--border);border-radius:12px;padding:12px;background:transparent;color:var(--fg)}
.row{display:grid;grid-template-columns:1fr 1fr auto;gap:12px}
@media(max-width:820px){.row{grid-template-columns:1fr}}
button{border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:#163056;color:var(--fg);cursor:pointer}
button.primary{background:var(--accent);border-color:var(--accent);color:#051225}
.small{font-size:12px;color:var(--muted)}
.err{color:var(--err)}
.pop-in{animation:pop .35s ease-out}
@keyframes pop{from{transform:scale(.97);opacity:0}to{transform:scale(1);opacity:1}}
.pulse{animation:pulse 2.5s ease-in-out infinite}
@keyframes pulse{0%{opacity:.85}50%{opacity:1}100%{opacity:.85}}
.routeWrap{overflow-x:auto;padding-bottom:8px}
.route{display:flex;align-items:center;gap:16px;padding:10px 6px}
.station{position:relative;display:flex;flex-direction:column;align-items:center;gap:6px;min-width:84px}
.dot{width:12px;height:12px;border-radius:50%;background:#4b5563;border:2px solid #94a3b8}
.dot.current{box-shadow:0 0 0 4px rgba(77,163,255,.25);background:var(--accent);border-color:var(--accent)}
.dot.selected{background:var(--ok);border-color:var(--ok)}
.dot.range{background:#2563eb;border-color:#2563eb}
.stCode{font:12px ui-monospace,Menlo,Consolas,monospace}
.stName{font-size:12px;color:var(--muted);text-align:center;max-width:120px}
.connector{height:2px;background:#334155;flex:1;min-width:20px}
.helper{color:var(--muted);font-size:12px;margin-top:6px}
.badge{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:11px}
footer{display:flex;justify-content:center;margin-top:6px}
footer a{color:var(--muted);text-decoration:none}
footer a:hover{text-decoration:underline}
.live{display:flex;gap:8px;align-items:center}
.dotlive{width:8px;height:8px;border-radius:50%;background:var(--ok);box-shadow:0 0 0 4px rgba(52,211,153,.15)}
</style>
</head>
<body>
<main>
  <header>
    <h1>IRCTC Booking Date Calculator</h1>
    <div class="small">Booking opens at 08:00 IST, 60 days before the train’s origin start date.</div>
  </header>

  <section class="card">
    <div class="row">
      <div>
        <label>Train number</label>
        <input id="trainNo" class="input" placeholder="e.g., 16527" inputmode="numeric" autocomplete="off">
      </div>
      <div>
        <label>Journey date</label>
        <input id="journey" class="input" type="text" placeholder="Select date" readonly>
        <div class="small">Pick from calendar.</div>
      </div>
      <div style="display:flex;align-items:end"><button id="fetch" class="primary">Fetch route</button></div>
    </div>
    <div id="err" class="small err"></div>
    <div id="warn" class="small" style="color:#f59e0b"></div>
  </section>

  <section id="routeCard" class="card" style="display:none">
    <div id="meta" class="small"></div>
    <div class="routeWrap"><div id="route" class="route"></div></div>
    <div class="helper">Tip: Click one station for Start, then another later station for End. You can still adjust using the dropdowns.</div>
    <div class="row" style="grid-template-columns:1fr 1fr auto;margin-top:10px">
      <div><label>Start (boarding)</label><select id="fromSel" class="input"></select></div>
      <div><label>End (destination)</label><select id="toSel" class="input"></select></div>
      <div style="display:flex;align-items:end"><button id="calc" class="primary">Calculate booking</button></div>
    </div>
  </section>

  <section id="resultCard" class="card pop-in" style="display:none">
    <div><b>Origin date (Day 1):</b> <span id="outOrigin"></span></div>
    <div style="margin-top:8px"><b>Booking opens:</b> <span id="outBooking" class="pulse"></span></div>
    <div style="margin-top:6px" class="small">
      08:00 IST, 60 days before origin. Aadhaar KYC is mandatory for 08:00–10:00 slot.
      <span id="countdown" class="badge" style="margin-left:8px"></span>
    </div>
  </section>

  <section id="liveCard" class="card" style="display:none">
    <div class="live"><span class="dotlive"></span><b>Live Status</b></div>
    <div id="liveMsg" style="margin-top:8px"></div>
  </section>

<footer class="small">
<a href="https://www.linkedin.com/in/kaarthik-ashok" target="_blank" rel="noopener">Made with ❤️ by Kaarthik</a>
</footer>
</main>

<script>
/* Calendar */
let _flatpickrReady=false;
function initCalendar(){
  if(!window.flatpickr) return calendarCDNFailed();
  _flatpickrReady=true;
  flatpickr("#journey",{altInput:true,altFormat:"F j, Y",dateFormat:"Ymd",allowInput:false,clickOpens:true});
}
function calendarCDNFailed(){
  const alt=document.createElement("script");
  alt.src="https://unpkg.com/flatpickr@latest/dist/flatpickr.min.js";
  alt.onload=initCalendar;
  alt.onerror=()=>{
    const j=document.getElementById('journey'); j.readOnly=false; j.type='date';
  };
  document.head.appendChild(alt);
}
document.addEventListener('DOMContentLoaded',()=>{setTimeout(()=>{if(!_flatpickrReady&&window.flatpickr) initCalendar();},500);});

/* App logic */
const DAY_MS=86400000;
const fmtDate=(y,m,d)=>new Intl.DateTimeFormat('en-IN',{timeZone:'Asia/Kolkata',year:'numeric',month:'2-digit',day:'2-digit'}).format(new Date(Date.UTC(y,m-1,d)));
const fmtFull=(ms)=>new Intl.DateTimeFormat('en-IN',{timeZone:'Asia/Kolkata',weekday:'short',month:'short',day:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}).format(new Date(ms)).replace(/\u200E/g,'');
const warnEl = document.getElementById('warn');

const errEl=document.getElementById('err');
const routeCard=document.getElementById('routeCard');
const resultCard=document.getElementById('resultCard');
const liveCard=document.getElementById('liveCard');
const liveMsg=document.getElementById('liveMsg');
const metaEl=document.getElementById('meta');
const routeEl=document.getElementById('route');
const fromSel=document.getElementById('fromSel');
const toSel=document.getElementById('toSel');
const outOrigin=document.getElementById('outOrigin');
const outBooking=document.getElementById('outBooking');
const countdownEl=document.getElementById('countdown');

let stations=[], bookingUTC=null, firstClickIndex=null, journeyYMD=null;

document.getElementById('fetch').addEventListener('click', fetchRoute);
document.getElementById('calc').addEventListener('click', calcBooking);

if('serviceWorker' in navigator){window.addEventListener('load',()=>navigator.serviceWorker.register('/service-worker.js').catch(()=>{}));}

function getSelectedYMD(){
  const el=document.getElementById('journey'); const v=(el.value||'').trim();
  if(/^\d{8}$/.test(v)) return v;                   // flatpickr format Ymd
  if(/^\d{4}-\d{2}-\d{2}$/.test(v)) return v.replace(/-/g,''); // native fallback
  return null;
}

async function fetchRoute(){
  errEl.textContent="";
  warnEl.textContent = "";
  routeCard.style.display='none'; resultCard.style.display='none'; liveCard.style.display='none';
  stations=[]; bookingUTC=null; firstClickIndex=null;

  const tn=(document.getElementById('trainNo').value||'').trim();
  const ymd=getSelectedYMD();
  journeyYMD=ymd;  // remember user’s boarding date

  if(!/^\d{3,5}$/.test(tn)){ errEl.textContent="Enter a valid train number (3–5 digits)."; return; }
  if(!/^\d{8}$/.test(ymd||"")) { errEl.textContent="Pick the journey date."; return; }

  const url=new URL('/.netlify/functions/trainStatus', location.origin);
  url.searchParams.set('train_number', tn);
  url.searchParams.set('departure_date', ymd);

  let payload;
  try{
    const res=await fetch(url.toString());
    const text=await res.text();
    if(!res.ok){ errEl.textContent="API error. Try a different date or train."; return; }
    payload=JSON.parse(text);
  }catch{ errEl.textContent="Could not reach server."; return; }

  const brief=payload.brief||{};
  stations=brief.stations||[];
  if(!stations.length){ errEl.textContent="No station data for that run."; return; }

  const cleanMsg=(brief.train_status_message||"").replace(/<[^>]+>/g,'').trim();
  metaEl.textContent=[brief.trainNumber?`Train: ${brief.trainNumber}`:null, brief.current_station?`Current: ${brief.current_station}`:null, cleanMsg||null].filter(Boolean).join(" • ");
  if(brief.current_station||cleanMsg){ liveCard.style.display=''; liveMsg.textContent=cleanMsg||`Current station: ${brief.current_station}`; }

  fromSel.innerHTML=stations.map((s,i)=>`<option value="${i}">${s.code} — ${s.name}</option>`).join('');
  toSel.innerHTML  =stations.map((s,i)=>`<option value="${i}">${s.code} — ${s.name}</option>`).join('');
  fromSel.value="0"; toSel.value=String(stations.length-1);

  renderRouteMap(brief.current_station||null);
  routeCard.style.display='';
}

function renderRouteMap(currentCode){
  routeEl.innerHTML="";
  stations.forEach((s,i)=>{
    if(i>0){const c=document.createElement('div'); c.className="connector"; routeEl.appendChild(c);}
    const node=document.createElement('div'); node.className="station"; node.dataset.index=i;
    const dot=document.createElement('div'); dot.className="dot"; if(currentCode&&s.code===currentCode) dot.classList.add('current'); dot.title=`${s.code} • ${s.name}`; dot.addEventListener('click',()=>onStationClick(i));
    const code=document.createElement('div'); code.className="stCode"; code.textContent=s.code;
    const name=document.createElement('div'); name.className="stName"; name.textContent=s.name;
    node.appendChild(dot); node.appendChild(code); node.appendChild(name); routeEl.appendChild(node);
  });
  updateHighlights();
}
function onStationClick(idx){
  if(firstClickIndex==null){ firstClickIndex=idx; fromSel.value=String(idx); }
  else { if(idx<=firstClickIndex){ firstClickIndex=idx; fromSel.value=String(idx); } else { toSel.value=String(idx); firstClickIndex=null; } }
  updateHighlights();
}
function updateHighlights(){
  const start=+fromSel.value||0, end=+toSel.value||stations.length-1;
  Array.from(routeEl.querySelectorAll('.station')).forEach((n,i)=>{
    const d=n.querySelector('.dot'); d.classList.remove('selected','range');
    if(i===start||i===end) d.classList.add('selected'); if(i>start&&i<end) d.classList.add('range');
  });
}

/* Fixed booking logic: origin = station-date − (dayCount−1) days */
function calcBooking(){
  if (!stations.length) { errEl.textContent = "Fetch route first."; return; }

  const start = +fromSel.value, end = +toSel.value;
  if (!Number.isInteger(start) || !Number.isInteger(end) || end <= start) {
    errEl.textContent = "Pick a valid Start and End in order.";
    return;
  }
  errEl.textContent = "";
  warnEl.textContent = "";

  const s = stations[start];
  const dayCount = Math.max(1, parseInt(s.dayCount || "1", 10));

  const picked = (journeyYMD || "").trim();              // what you chose in calendar
  if (!/^\d{8}$/.test(picked)) { errEl.textContent = "Pick the journey date."; return; }

  const apiStation = (s.actDepDate || s.actArrDate || "").trim(); // API’s station date if present
  const addDaysUTC = (utc, d) => utc + d*DAY_MS;

  // Helpers
  const ymdToUTC = (ymd) => Date.UTC(+ymd.slice(0,4), +ymd.slice(4,6)-1, +ymd.slice(6,8));
  const utcToYMD = (utc) => {
    const d = new Date(utc);
    const y = d.getUTCFullYear(), m = String(d.getUTCMonth()+1).padStart(2,'0'), dd = String(d.getUTCDate()).padStart(2,'0');
    return `${y}${m}${dd}`;
  };

  let originUTC, stationUTC, warnMsg = "";

  if (/^\d{8}$/.test(apiStation)) {
    if (apiStation === picked) {
      // You picked the boarding date at this station
      stationUTC = ymdToUTC(apiStation);
      originUTC  = addDaysUTC(stationUTC, -(dayCount - 1));
      // no warning
    } else {
      // You picked the run’s ORIGIN date; compute station date from origin
      originUTC  = ymdToUTC(picked);
      stationUTC = addDaysUTC(originUTC, (dayCount - 1));

      const sdY = new Date(stationUTC).toLocaleDateString('en-IN', { timeZone: 'Asia/Kolkata', day:'2-digit', month:'short', year:'numeric' });
      warnMsg = `Heads up: for this run, ${s.code} is on ${sdY}. We kept your origin date and will compute booking from it.`;
    }
  } else {
    // No API station date. Heuristic: if dayCount==1, assume picked is origin; else assume picked is station date but tell user.
    if (dayCount === 1) {
      originUTC  = ymdToUTC(picked);
      stationUTC = originUTC; // same day
    } else {
      stationUTC = ymdToUTC(picked);
      originUTC  = addDaysUTC(stationUTC, -(dayCount - 1));
      const oStr = new Date(originUTC).toLocaleDateString('en-IN', { timeZone:'Asia/Kolkata', day:'2-digit', month:'short', year:'numeric' });
      warnMsg = `Assuming you picked the boarding date. Origin would be ${oStr}.`;
    }
  }

  if (warnMsg) warnEl.textContent = warnMsg;

  // Display origin and compute booking @ 08:00 IST, 60 days prior
  const o = new Date(originUTC);
  const oY = o.getUTCFullYear(), oM = o.getUTCMonth() + 1, oD = o.getUTCDate();
  outOrigin.textContent = fmtDate(oY, oM, oD);

  bookingUTC = originUTC - 60*DAY_MS + ((8*60 - 330) * 60 * 1000);
  outBooking.textContent = fmtFull(bookingUTC) + " IST";
  resultCard.style.display = '';

  renderCountdown();
  if (window._cd) clearInterval(window._cd);
  window._cd = setInterval(renderCountdown, 30000);
}
  
function renderCountdown(){
  if(!bookingUTC){ countdownEl.textContent=""; return; }
  const diff=bookingUTC-Date.now(); if(diff<=0){ countdownEl.textContent="Open now"; return; }
  const d=Math.floor(diff/DAY_MS), h=Math.floor((diff%DAY_MS)/3600000), m=Math.floor((diff%3600000)/60000);
  countdownEl.textContent=`Opens in ${d}d ${h}h ${m}m`;
}
</script>
</body>
</html>
